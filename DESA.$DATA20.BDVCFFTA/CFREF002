?ENV COMMON;RUNNAMED;COMPACT;SYMBOLS;INSPECT;SAVE ALL
?SAVEABEND
?SQL (RELEASE2,PAGES 800);SQLMEM EXT
?SEARCH $SYSTEM.SYSTEM.CBL85UTL
?SEARCH $SYSTEM.SYSTEM.CLULIB
?SEARCH $DCYC01.INFROJA0.LTALLIB
?SEARCH $SYSTEM.SYSTEM.COBOLLIB
?SEARCH $DATA20.BDVCFOJA.CFREFRFC

?OPTIMIZE 2;NOWARN

 IDENTIFICATION DIVISION.
 PROGRAM-ID. CFREFFIS-DIVS.
 AUTHOR.     ASISTICA - Alvarez Bastida, Eduardo
                      & Barcenas Padilla, Victor Manuel
                      & Cano, Luis
                      & Hamilton, Margaret
                      - www.asistica.com
 DATE-WRITTEN. (08JUL2016)
 ENVIRONMENT DIVISION.
 CONFIGURATION SECTION.

 SPECIAL-NAMES.
    FILE #TERM                      IS HOME-TERM
    FILE $DATA20.BDVCFOJA.CFREFRFC  IS CFREFRFC-LIB
    FILE $DCYC01.INFROJA0.LTALLIB   IS LTAL-LIB
    FILE $SYSTEM.SYSTEM.COBOLLIB    IS COBOL-LIB.

 INPUT-OUTPUT SECTION.
 FILE-CONTROL.

 SELECT FILE-SALIDA   ASSIGN TO #DYNAMIC
        ORGANIZATION         IS SEQUENTIAL
        ACCESS MODE          IS SEQUENTIAL
        FILE STATUS          IS WS-FILE-STATUS.

 DATA DIVISION.
 FILE SECTION.

 FD FILE-SALIDA
    RECORD CONTAINS 250 CHARACTERS
    LABEL RECORDS ARE OMITTED.
    01 REGSALIDA             PIC X(250).

 WORKING-STORAGE SECTION.

 EXEC SQL INCLUDE SQLCA END-EXEC.
 EXEC SQL INCLUDE SQLSA END-EXEC.
 EXEC SQL BEGIN DECLARE SECTION END-EXEC.
 EXEC SQL INVOKE =ENTIDAD  AS ENTIDAD-REG  END-EXEC.
 EXEC SQL INVOKE =SAREACB  AS SAREACB-REG  END-EXEC.
 EXEC SQL INVOKE =SATRXCTO AS SATRXCTO-REG END-EXEC.
 EXEC SQL INVOKE =SCODPOST AS SCODPOST-REG END-EXEC.
 EXEC SQL INVOKE =SCTOFIDE AS SCTOFIDE-REG END-EXEC.
 EXEC SQL INVOKE =SEDOPAIS AS SEDOPAIS-REG END-EXEC.
 EXEC SQL INVOKE =SEMISORA AS SEMISORA-REG END-EXEC.
 EXEC SQL INVOKE =SEMPNEGO AS SEMPNEGO-REG END-EXEC.
 EXEC SQL INVOKE =SJOURNAL AS SJOURNAL-REG END-EXEC.
 EXEC SQL INVOKE =SPAIS    AS SPAIS-REG    END-EXEC.
 EXEC SQL INVOKE =SR2FISTT AS SR2FISTT-REG END-EXEC.
 EXEC SQL INVOKE =SREFISAC AS SREFISAC-REG END-EXEC.
 EXEC SQL INVOKE =SREFISCM AS SREFISCM-REG END-EXEC.
 EXEC SQL INVOKE =SREFISDF AS SREFISDF-REG END-EXEC.
 EXEC SQL INVOKE =SREFISDO AS SREFISDO-REG END-EXEC.
 EXEC SQL INVOKE =SREFISDT AS SREFISDT-REG END-EXEC.
 EXEC SQL INVOKE =SREFISMC AS SREFISMC-REG END-EXEC.
 EXEC SQL INVOKE =SREFISPC AS SREFISPC-REG END-EXEC.
 EXEC SQL INVOKE =SREFISPE AS SREFISPE-REG END-EXEC.
 EXEC SQL INVOKE =SREFISRE AS SREFISRE-REG END-EXEC.
 EXEC SQL INVOKE =SREFISTT AS SREFISTT-REG END-EXEC.
 EXEC SQL INVOKE =SRFCATAL AS SRFCATAL-REG END-EXEC.
 EXEC SQL INVOKE =SRFDISCL AS SRFDISCL-REC END-EXEC.
 EXEC SQL INVOKE =SRFFOLMC AS SRFFOLMC-REG END-EXEC.
 EXEC SQL INVOKE =SREFISFC AS SREFISFC-REG END-EXEC.

 01 H-NEGOCIO                      PIC X(02) VALUE SPACES.
 01 H-FECHA-HOY                    PIC 9(08).
 01 H-HORA-HOY                     PIC 9(08).
 01 H-WSS-FOLIO                    PIC X(36).
 01 hNumPersonaAnt                 PIC 9(9).
 01 hNumContratoAnt                PIC 9(9).
 01 H-Liquidaciones.
    02 hNumContrato                PIC 9(9).
    02 hNumPersona                 PIC 9(9).
    02 hCveTpoPersona              PIC X(4).
    02 hCveRolCto                  PIC X(4).
    02 hCveRFC                     PIC X(13).
    02 hNombrePersona              PIC X(135).
    02 hNacionalidad               PIC X(2).
    02 hNumInstrumento             PIC 9(9).
    02 hDescInstrumento            PIC X(17).
    02 hMesIniVigencia             PIC 99.
    02 hMesFinVigencia             PIC 99.
    02 hTpoProceso                 PIC X.
    02 hPorcDistribucion           PIC 9(2)V9(8).
    02 hDividendoBrutoSujetoRet    PIC S9(16)V9(2).
    02 hISRretenidoExtranjero      PIC S9(16)V9(2).
    02 hTotalDividendo             PIC S9(16)V9(2).
    02 hRetencion10ISRadivExt      PIC S9(16)V9(2).
    02 hInfoDomicilio.
       03 hNumEstado               PIC 9(4).
       03 hCodxPostal              PIC X(8).
       03 hCvePais                 PIC X(2).
       03 hTxtDelegacionMunicipio  PIC X(25).
       03 hTxtCalleNum             PIC X(45).
       03 hTxtColonia              PIC X(30).
       03 hNumCentroReparto        PIC 9(5).
       03 hDescEstado              PIC X(45).

 EXEC SQL END DECLARE SECTION END-EXEC.
 EXEC SQL CONTROL QUERY INTERACTIVE ACCESS OFF END-EXEC.

 EXEC sql declare CUR_DIVS cursor for
      SELECT rfpc_num_contrato
            ,rfdf_num_persona
            ,UPPER(TRIM(rfpe_cve_tipo_persona))
            ,UPPER(TRIM(rfpe_cve_rol_contrato))
            ,UPPER(TRIM(rfdf_codx_rfc_cfdi))
            ,CASE WHEN SUBSTRING(TRIM(UPPER(rfpe_cve_tipo_persona))
                  from 1 for 1)="F" THEN
                  TRIM(UPPER(rfpe_nomb_apellido_paterno))||" "||
                  TRIM(UPPER(rfpe_nomb_apellido_materno))||" "||
                  TRIM(UPPER(rfpe_nomb_persona_fisica))
                  ELSE TRIM(UPPER(rfpe_nomb_razon_social)) END
            ,UPPER(TRIM(rfpe_cve_pais_nacionalidad))
            ,rfpc_num_producto
            ,UPPER(TRIM(emis_cve_tipo_valor))||"-"||
             TRIM(UPPER(emis_desc_valor))||"-"||
             TRIM(UPPER(emis_cve_serie_valor))
            ,CASE when rfac_fech_alta>rfac_anio*10000+100
                   and rfac_fech_alta>19100101
                  then cast(rfac_fech_alta/100   as numeric(6,0))
                      -cast(rfac_fech_alta/10000 as numeric(4,0))*100
                  else 1 END
            ,rfac_anio_mes-cast(rfac_anio_mes/100 as numeric(4,0))*100
            ,CASE WHEN jour_num_id is NULL THEN "E" ELSE "R" END
            ,AVG(rfdf_porc_distribucion)/100
            ,SUM(CASE when :jour-campo-ad2=1
                      then cast(rfpc_impo_div_nac_gravad
                         *:rffc-factor-piramidacion as numeric(18,2))
                      when :jour-campo-ad2=2
                      then cast(rfpc_impo_div_nac_exento
                         *:rffc-factor-piramidacion as numeric(18,2))
                      when :jour-campo-ad2=3
                      then cast(rfpc_impo_div_nac_gravad
                         *:rffc-factor-piramidacion as numeric(18,2))
                          +cast(rfpc_impo_div_nac_exento
                         *:rffc-factor-piramidacion as numeric(18,2))
                      when :jour-campo-ad2 in (4,5)
                      then rfpc_impo_div_ext_brut
                 else 0 END)
            *CAST(AVG(rfdf_porc_distribucion/100) as numeric(12,2))
            ,SUM(CASE when :jour-campo-ad2=1
                      then cast(rfpc_impo_div_nac_gravad
                              *:rffc-factor-piramidacion
                               -rfpc_impo_div_nac_gravad as numeric(18,2))
                      when :jour-campo-ad2=2
                      then cast(rfpc_impo_div_nac_exento
                              *:rffc-factor-piramidacion
                               -rfpc_impo_div_nac_exento as numeric(18,2))
                      when :jour-campo-ad2=3
                      then cast(rfpc_impo_div_nac_gravad
                              *:rffc-factor-piramidacion
                               -rfpc_impo_div_nac_gravad as numeric(18,2))
                         + cast(rfpc_impo_div_nac_exento
                              *:rffc-factor-piramidacion
                               -rfpc_impo_div_nac_exento as numeric(18,2))
                      when :jour-campo-ad2 in (4,5)
                      then cast(CASE when trim(upper(emis_cve_tipo_valor))="52"
                                     then 0 else rfpc_impo_isr_ext_acred END
                           as numeric(18,2))
                 else 0 END)
            *CAST(AVG(rfdf_porc_distribucion/100) as numeric(12,2))
            ,SUM(CASE when :jour-campo-ad2=1 then rfpc_impo_div_nac_gravad
                      when :jour-campo-ad2=2 then rfpc_impo_div_nac_exento
                      when :jour-campo-ad2=3 then rfpc_impo_div_nac_gravad
                                     +rfpc_impo_div_nac_exento
                      when :jour-campo-ad2 in (4,5)
                      then rfpc_impo_div_ext_neto
                 else 0 END)
            *CAST(AVG(rfdf_porc_distribucion/100) as numeric(12,2))
            ,SUM(CASE when :jour-campo-ad2=1 then rfpc_impo_isr_nac_adicional
                      when :jour-campo-ad2=2 then 0
                      when :jour-campo-ad2=3 then rfpc_impo_isr_nac_adicional
                      when :jour-campo-ad2 in (4,5)
                      then rfpc_impo_isr_ext_nacional
                 else 0 END)
            *CAST(AVG(rfdf_porc_distribucion/100) as numeric(12,2))
       from =srefisac
             left join =srefispc on rfac_num_contrato=rfpc_num_contrato
             left join =semisora on rfpc_num_producto=emis_num_producto
             left join =sempnego on rfac_cve_negocio=eneg_cve_negocio
             left join =sctofide on rfac_num_contrato=fide_num_contrato
             left join =srefisdf on (rfac_anio_mes, rfac_num_contrato)
                                   =(rfdf_anio_mes, rfdf_num_contrato)
             left join =srefispe
                    on (rfdf_anio_mes,rfdf_num_contrato,rfdf_num_persona)
                      =(rfpe_anio_mes,rfpe_num_contrato,rfpe_num_persona)
             left join =sjournal
                    on (rfpc_num_contrato,rfdf_num_persona,:jour-campo-ad2)
                     = (jour_num_contrato
                       ,jour_num_persona
                       ,jour_campo_ad2)
             left join =sareacb  on rfac_numf_area=arcb_numf_area
             left join =satrxcto on (rfac_num_contrato,"DIST")
                                   =(atxc_num_contrato,atxc_cve_atributo)
       WHERE
             UPPER(TRIM(rfac_cve_tipo_contrato)) in ("BA","TE")
        and  rfac_num_uso_contrato not in (10,12,13,15,19,20,21,22)
        and  SUBSTRING(arcb_cve_seguridad from 1 for 6)<>"003002"
        and  SUBSTRING(arcb_cve_seguridad from 1 for 9)<>"003007004"
        and  CASE when atxc_numf_atributo_univaluado is null then 0 else
                       atxc_numf_atributo_univaluado END NOT in (2,3,4)
        and (jour_num_id is NULL OR
             jour_num_id=(select MAX(ufo.jour_num_id)
                           from =sjournal UFO
                           where UFO.jour_num_contrato=jour_num_contrato
                             and UFO.jour_num_persona=jour_num_persona
                             and UFO.jour_campo_ad2=jour_campo_ad2
                          browse access))
           and (jour_status is NULL OR
                TRIM(UPPER(jour_status)) in ("CANCELADO","PEND.CANC"))
        and CASE when fide_num_contrato is NULL then 0 else 1 end
         = :fide-num-contrato
        and (:fide-num-contrato = 1 OR
              UPPER(TRIM(rfpe_cve_tipo_persona))<>"MORA")
        and TRIM(UPPER(eneg_cve_empresa))= :eneg-cve-empresa
        and rfac_anio=2015
        and rfpc_anio_mes>=rfac_anio*100
        and (   (:jour-campo-ad2=1
                  and TRIM(UPPER(emis_cve_tipo_valor)) NOT in ("1A","1E","1I")
                  and rfpc_impo_div_nac_gravad+rfpc_impo_isr_nac_adicional<>0)
             OR (:jour-campo-ad2=2
                  and TRIM(UPPER(emis_cve_tipo_valor)) NOT in ("1A","1E","1I")
                  and rfpc_impo_div_nac_exento<>0)
             OR (:jour-campo-ad2=3
                  and TRIM(UPPER(emis_cve_tipo_valor)) NOT in ("1A","1E","1I")
                  and rfpc_impo_div_nac_gravad+rfpc_impo_isr_nac_adicional
                     +rfpc_impo_div_nac_exento<>0)
             OR (:jour-campo-ad2 in (4,5)
                  and TRIM(UPPER(emis_cve_tipo_valor)) in ("1A","1E","1I","52")
                  and rfpc_impo_div_ext_brut+rfpc_impo_isr_ext_nacional<>0
            ))
    group by 1,2,3,4,5,6,7,8,9,10,11,12
    order by 1,2,9
  FOR BROWSE ACCESS
  END-EXEC.

 01 ws-file-status.
    02 stat-1                          pic  9.
    02 stat-2                          pic  9.
 01 file-status redefines ws-file-status.
    02 wss-file-status                 pic  x(02).
       88 RECEIVE-FILE-OK              value "00".
       88 SHORT-REC-READ               value "04".
       88 CLOSE-FROM-REQUESTER         value "10".
       88 INDEX-SEQ-VIOLATION          value "21".
       88 DUPLICATE-RECORD             value "22".
       88 NOT-FOUND                    value "23".
       88 BOUNDARY-VIOLATION           value "24".
       88 INVALID-KEY                  value "21" thru "24".
       88 FILE-IS-FULL                 value "34".
       88 POSITION-UNDEFINED           value "46".
       88 IO-ERROR                     value "01" thru "99".

 01 w-define-info.
    02 w-intname                           pic x(24).
    02 w-class                             pic x(16).
    02 w-attribute-name                    pic x(16).
    02 w-extname                           pic x(36).
    02 w-extname-len                       native-2.
    02 w-value-len                         native-2.
    02 w-error                             native-2.
       88 ENOERR                           value 0.
       88 EEOF                             value 1.
       88 ESYSMSG                          value 6.
       88 ENOCOMPLETION                    value 40.
       88 ESQLERR                          value 197.
       88 INVALIDPARAM                     value 512.
       88 EBADFILE                         value 4197.
       88 EUNKNOWN                         value 4208.
       88 EDEFINEERR                       value 4212.
       88 EERR                             values are -32767 thru -1,
                                                           1 thru 32767.
*** Manejo de Archivo de SALIDA
 01 WSS-KEY-ENVIO                      PIC S9(09) COMP.

*** Variables Estandares
 COPY WSS-VARS-STND-000 OF "$DESA12.SCOGLCPA.C85DEFPG".
 COPY ESS-VARS-STND-000 OF "$DESA12.SCOGLCPA.C85DEFPG".
 COPY ESS-VARS-STND-010 OF "$DESA12.SCOGLCPA.C85DEFPG".
 COPY ESS-VARS-STND-020 OF "$DESA12.SCOGLCPA.C85DEFPG".

 01 VALIDA-RFC-IN.
   02 LINKD-NUM-CONTRATO          PIC 9(09).
   02 LINKD-NUM-PERSONA           PIC 9(09).
   02 LINKD-CVE-TIPO-PERSONA      PIC X(04).
   02 LINKD-CODX-RFC              PIC X(13).
   02 LINKD-CODX-CURP             PIC X(18).
   02 LINKD-NACIONALIDAD          PIC X(02).
   02 LINKD-RFC-SAT               PIC X(01).
   02 LINKD-LIB-RESP              PIC X(01).

*** Generales
 01 WSS-PROG-ID                    PIC  X(13)       VALUE "<<CFREFFIS>> ".
 01 WSS-ERROR-FILE                 PIC S9(04) COMP.
 01 WSS-FECH-REPORTE               PIC  9(08)       VALUE ZEROES.

 01 P-GETPARAMTEXT.
    05 P-PARAMETRO                 PIC  X(12)        VALUE SPACES.
    05 P-VALOR-ALFANUM             PIC  X(16)        VALUE SPACES.
    05 P-VALOR-NUM                 PIC  9(09)        VALUE ZEROES.
    05 P-RESULTADO                 PIC  S9999 COMP.
    05 WSS-OPC-ENVIO               PIC  9(04)        VALUE ZEROES.
    05 WSS-TPO-CONT                PIC  X(01)        VALUE SPACES.
    05 WSS-EMPRESA                 PIC  X(04)        VALUE SPACES.
    05 WSS-FEC-EXP                 PIC  9(08)        VALUE ZEROES.
    05 WSS-HR-EXP                  PIC  9(08)        VALUE ZEROES.
    05 WSS-NUM-RETEN               PIC  X(02)        VALUE SPACES.
    05 WSS-TIP-EXP                 PIC  X(01)        VALUE SPACES.
    05 WSS-EJERCICIO1              PIC  9999         VALUE ZEROES.
    05 WSS-NUMERO-EXP              PIC  9(02)        VALUE ZEROES.

 01 WS88-COD-ERROR-SQL          PIC S9(04) COMP VALUE ZEROS.
    88  WS88-SQL-EOF            VALUE 1.

 01 WSS-NOMBRE-ARCHIVO.
    02 WSS-VOLUMEN                  PIC  X(08)             VALUE "$DATA20." .
    02 WSS-SUBVOLUMEN               PIC  X(09)             VALUE "BDVCFDAT.".
    02 WSS-ARCHIVO                  PIC  X(08)             VALUE SPACES     .

 01 WSS-ERROR-TAL                      PIC S9(04) COMP VALUE 0.
 01 WSS-FILE-LEN                       PIC S9(04) COMP VALUE 25.
 01 WSS-FILE-CODE                      PIC S9(04) COMP VALUE 0.
 01 WSS-PRIMARY                        NATIVE-2 VALUE 2048.
 01 WSS-SECONDARY                      NATIVE-2 VALUE 512.
 01 WSS-MAXEXTENTS                     PIC S9(04) COMP VALUE 800.
 01 WSS-FILETYPE                       PIC S9(04) COMP VALUE 2.
 01 WSS-RECORD                         PIC  9(05) COMP VALUE 250.
 01 WSS-BLOCK-LEN                      PIC S9(04) COMP VALUE 4096.
 01 WSS-FILE-NUM                       PIC S9(04) COMP VALUE 0.
 01 WSS-ACCESS                         PIC S9(04) COMP VALUE 2.
 01 WSS-EXCLUSION                      PIC S9(04) COMP VALUE 0.
 01 WSS-SALIDA-ERROR-CODE              PIC S9(04) COMP VALUE ZEROES.
 
 
 
*--------------------------------------------------------------------------------------------
*-AG1-AG7-LEX-CO
*-------------------------------------------------------------------------------------------
 01 WSS-AG1-REG.
    02 WSS-AG1-NOMBRE               PIC X(80).
    02 WSS-AG1-CLAVE-PRODUCTO       PIC X(07). 
		02 WSS-AG1-CONTRATO             PIC X(18).
		02 WSS-AG1-RFC                  PIC X(13).
		02 WSS-AG1-CURP                 PIC X(18).
		02 WSS-AG1-EMPRESA              PIC X(04). 
		02 WSS-AG1-NACIONALIDAD         PIC X(10).
		
 01 WSS-AG2-REG.  
		02 WSS-AG2-TITULO-PRODUCTO      PIC X(45).              
		02 WSS-AG2-PERIODO-INICIAL    	PIC X(10).
		02 WSS-AG2-PERIODO-FINAL      	PIC X(10).
		02 WSS-AG2-EJERCICIO         		PIC X(04).
		02 WSS-AG2-PROPORCION        		PIC X(06).
		02 WSS-AG2-MONEDA            		PIC X(20) VALUE "MXN".
		02 WSS-AG2-FECHA-EXPEDICION   	PIC X(10).
		02 WSS-AG2-TIPO-EXPEDICION   		PIC X(01) VALUE "T".
		02 WSS-AG2-HORA-EXPEDICION   		PIC X(08).
		02 WSS-AG2-HORADIF           		PIC X(06) VALUE"-05:00".
		02 WSS-AG2-SERIECSD          		PIC X(25) VALUE SPACES.
		02 WSS-AG2-TIPO-DIVIDENDO       PIC X(2).
		02 WSS-AG2-FILLER              	PIC X(05) VALUE SPACES.		
 01 WSS-AG3-REG.  
		02 WSS-AG3-CALLE-NUMERO         PIC X(40).
		02 WSS-AG3-COLONIA              PIC X(40).
		02 WSS-AG3-CIUDAD               PIC X(20).
		02 WSS-AG3-CODIGO-POSTAL        PIC X(05). 
		02 WSS-AG3-CODIGO-CR            PIC X(05). 
		02 WSS-AG3-FECHA-CORTE          PIC X(10).
		02 WSS-AG3-FILLER               PIC X(30) VALUE SPACES.
		
 01 WSS-AG4-REG.
    02 WSS-AG4-FECHA-EXPEDICION   	PIC X(10).
		02 WSS-AG4-TIPO-EXPEDICION   		PIC X(01) VALUE "T".
		02 WSS-AG4-HORA-EXPEDICION   		PIC X(08).
		02 WSS-AG4-HORADIF           		PIC X(06) VALUE"-05:00".

 01 WSS-AG5-REG.                                          
		02 WSS-AG5-RFC-EMISOR           PIC X(13).
		02 WSS-AG5-CURP-EMISOR          PIC X(18).
		02 WSS-AG5-NOMBRE-EMISOR        PIC X(80).
		02 WSS-AG5-LUGAR-EXPEDICION     PIC X(15).
		02 WSS-AG5-FECHA-EXPEDICION     PIC X(10).
		02 WSS-AG5-FILLER               PIC X(14) VALUE SPACES.
		
 01 WSS-AG6-REG.
		02 WSS-AG6-DIR-EMISOR           PIC X(150).
		
 01 WSS-AG7-REG.    
		02 WSS-AG7-VER-CFDI             PIC X(3).
		02 WSS-AG7-VER-COMP             PIC X(3).
		02 WSS-AG7-TIPO-PAGO-RET        PIC X(16).
		02 WSS-AG7-CVE-RET              PIC X(2).
				
 01 WSS-LEX-REG.    
    02 WSS-LEX-LUGAR-EXP               PIC  X(79).				
				
				

 01 WSS-CO8-REG.    
    02 WSS-DIG-VERIF               PIC  X(08)  VALUE "00000000".
    02 WSS-C08-ARRAY               PIC  X(01)  VALUE "-".
    02 WSS-NODE-EXP                PIC  X(02)  VALUE "00".
    02 WSS-FILLER                  PIC  X(139) VALUE SPACES.
    
 01 WSS-LY-REG.                                                                               
    02 WSS-LY1                   PIC X(150).
    02 WSS-LY2                   PIC X(150).
    02 WSS-LY3                   PIC X(150).
    02 WSS-LY4                   PIC X(150).
    02 WSS-LY5                   PIC X(150).
    02 WSS-LY61                  PIC X(150).
    02 WSS-LY62                  PIC X(150).
    02 WSS-LY71                  PIC X(150).
    02 WSS-LY72                  PIC X(150).
   	02 WSS-LY8                   PIC X(150).
   	
    02 WSS-LY91-CB-00            PIC X(150).                    
		02 WSS-LY92-1-CB-00          PIC X(116).
		02 WSS-LY92-3-CB-00          PIC X(25). 
    02 WSS-LY93-CB-00            PIC X(150).
          
		02 WSS-LY91-CB-01            PIC X(150).
		02 WSS-LY92-1-CB-01          PIC X(150).
		02 WSS-LY92-3-CB-01          PIC X(34). 
		02 WSS-LY93-CB-01            PIC X(150).
		   
		02 WSS-LY91-BN-00            PIC X(150).             
		02 WSS-LY92-1-BN-00          PIC X(61). 
		02 WSS-LY92-3-BN-00          PIC X(36). 
		
		02 WSS-LY91-BN-01            PIC X(150).
		02 WSS-LY92-1-BN-01          PIC X(97). 
		02 WSS-LY92-3-BN-01          PIC X(36).
             
    02 WSS-LY91                  PIC X(150).
    02 WSS-LY92                  PIC X(150).
    02 WSS-LY93                  PIC X(150).
    


 01 WSS-RNG-REG.
    02 RNG-Emisora          PIC X(24).
    02 RNG-DivNal           PIC S9(16)V9(02).
    02 RNG-DivPiramidado    PIC x(19) VALUE SPACES.
    02 RNG-IsrAcreditable   PIC x(19) VALUE SPACES.
    02 RNG-IsrAdicional     PIC S9(16)V9(02).
    
 01 WSS-TNG-REG.    
    02 xAc-TNG-TotDivNal          PIC S9(16 )V9(02). 
    02 xAc-TNG-TotDivPiramidado   PIC x(19) VALUE SPACES.
    02 xAc-TNG-TotIsrAcreditable  PIC x(19) VALUE SPACES.
    02 xAc-TNG-TotIsrAdicional    PIC S9(16)V9(02).
 01 WSS-T-CFA                     PIC X(150) OCCURS 1000. 
    
 01 WSS-RNE-2-REG.
    02 RNE-2-Emisora          PIC X(24).
    02 RNE-2-DivNal           PIC S9(16)V9(02).
    02 RNE-2-DivPiramidado    PIC x(19) VALUE SPACES
    02 RNE-2-IsrAcreditable   PIC x(19) VALUE SPACES
    02 RNE-2-IsrAdicional     PIC S9(16)V9(02).

 01 WSS-RNE-3-REG.
    02 RNE-3-Emisora          PIC X(24).
    02 RNE-3-DivNal           PIC S9(16)V9(02).
    02 RNE-3-DivPiramidado    PIC S9(16)V9(02).
    02 RNE-3-IsrAcreditable   PIC S9(16)V9(02).
    02 RNE-3-IsrAdicional     PIC x(19) VALUE SPACES.
     
 
 01 WSS-TNE-2-REG.    
    02 xAc-TNE-2-TotDivNal          PIC S9(16 )V9(02). 
    02 xAc-TNE-2-TotDivPiramidado   PIC x(19) VALUE SPACES.
    02 xAc-TNE-2-TotIsrAcreditable  PIC x(19) VALUE SPACES.
    02 xAc-TNE-2-TotIsrAdicional    PIC x(19) VALUE SPACES.
    
 01 WSS-TNE-3-REG.    
    02 xAc-TNE-3-TotDivNal          PIC S9(16 )V9(02). 
    02 xAc-TNE-3-TotDivPiramidado   PIC S9(16 )V9(02). 
    02 xAc-TNE-3-TotIsrAcreditable  PIC S9(16 )V9(02). 
    02 xAc-TNE-3-TotIsrAdicional    PIC x(19) VALUE SPACES.
    

 01 WSS-T-CFB-PIRAMIDADO          PIC X(150) OCCURS 1000.
    
 
 01 WSS-RE1-1-REG.     
    02 RE11-DIVIDENDO-EXTRANJERA       PIC X(19) SPACES.
    02 RE11-ISR-EXTRANJERA             PIC X(19) SPACES.
    02 RE11-DIVIDENDO-NACIONAL-GRAVADO PIC S9(16 )V9(02).
    02 RE11-ISR-NACIONAL               PIC S9(16 )V9(02).
    02 RE11-DIVIDENDO-NACIONAL-EXENTO  PIC X(19) SPACES.
    
 01 WSS-RE1-2-REG.     
    02 RE12-DIVIDENDO-EXTRANJERA       PIC X(19) SPACES.
    02 RE12-ISR-EXTRANJERA             PIC X(19) SPACES.
    02 RE12-DIVIDENDO-NACIONAL-GRAVADO PIC X(19) SPACES.
    02 RE12-ISR-NACIONAL               PIC X(19) SPACES.
    02 RE12-DIVIDENDO-NACIONAL-EXENTO  PIC S9(16 )V9(02).
    
 01 WSS-RE1-4-REG.     
    02 RE14-DIVIDENDO-EXTRANJERA       PIC S9(16 )V9(02).
    02 RE14-ISR-EXTRANJERA             PIC S9(16 )V9(02).
    02 RE14-DIVIDENDO-NACIONAL-GRAVADO PIC X(19) SPACES.
    02 RE14-ISR-NACIONAL               PIC X(19) SPACES.
    02 RE14-DIVIDENDO-NACIONAL-EXENTO  PIC X(19) SPACES.

 01 WSS-RE2-3-REG.
    02 RE23-DIV-ACUMULABLE            PIC S9(16 )V9(02).
    02 RE23-RET-EXT                   PIC S9(16 )V9(02).
    02 RE23-DIV-PIRAMIDADO            PIC X(19) SPACES.
    02 RE23-ISR-ACREDITABLE           PIC X(19) SPACES.
    
 01 WSS-RE2-5-REG.
    02 RE25-DIV-ACUMULABLE           PIC X(19) SPACES.
    02 RE25-RET-EXT                  PIC X(19) SPACES.
    02 RE25-DIV-PIRAMIDADO           PIC S9(16 )V9(02).
    02 RE25-ISR-ACREDITABLE          PIC S9(16 )V9(02).
                
 01  WSS-T-CFB                   PIC X(150) OCCURS 1000.
 01  WSS-T-CFC                   PIC X(150) OCCURS 1000.
    
 01 WSS-CF-LY-REG.                                        
    02 WSS-CF-LY1                PIC X(150).
    02 WSS-CF-LY2                PIC X(150).
    02 WSS-CF-LY3                PIC X(150).
    02 WSS-CF-LY4                PIC X(150).
    02 WSS-CF-LY5                PIC X(150).
    02 WSS-CF-LY61               PIC X(150).
    02 WSS-CF-LY62               PIC X(150).
    02 WSS-CF-LY71               PIC X(150).
    02 WSS-CF-LY72               PIC X(150).
    02 WSS-CF-LY8                PIC X(150).
    02 WSS-CF-LY91               PIC X(150).
    02 WSS-CF-LY92               PIC X(150).    
 

*--------------------------------------------------------------------------------------------
*-CONTROL                                                                                        
*--------------------------------------------------------------------------------------------
 01 xAG5RFCemisor       PIC  X(12).              
 01 xAG5NombreEmisor    PIC  X(80).
 01 xAG6DirEMISOR       PIC  X(150).
 01 xAG5LugarExpedicion PIC  X(15).
 01 xTipoRetencion      PIC  X(16).
 01 xSelectProceso      PIC  X(50).  
 01 xLEXLugarExp        PIC  X(79).
 01 xTipoReExpedicion   PIC  X(02).
 01 xFlagDemo           PIC  9(1)) VALUE ZEROS. 
*  Expedicion-Reexpedicion
 01 xMes                PIC  9(2).
 01 xDia                PIC  9(2).
 01 xHora               PIC  9(2).
 01 xMin                PIC  9(2).
 01 xTipoDividendo      PIC  9(1) VALUE ZEROS.
 
 01 WSS-CR              PIC  9(3) VALUE 0.
 01 C-CFBP              PIC  9(4) VALUE 0.
 01 C-CFB               PIC  9(4) VALUE 0.
 01 C-CFA               PIC  9(4) VALUE 0.
 01 C-CFC               PIC  9(4) VALUE 0. 
 
 
 01 WSS-CTRL-REG.                                                                                 
   02 WSS-CTRL-PRODUCTO                 PIC  X(5) VALUE SPACES.
   02 WSS-CTRL-FILLER2                  PIC  X(2) VALUE SPACES.            
   02 WSS-CTRL-TRAMA                    PIC  X(3) VALUE SPACES.
	 02 WSS-CTRL-COD-REP                  PIC  X(5) VALUE "00000".                                           
	 02 WSS-CTRL-FOLIO-PAG                PIC  X(7) VALUE "0000001".
	 02 WSS-CTRL-PLAZA                    PIC  X(3) VALUE "001".
	 02 WSS-CTRL-CONSECUTIVO-REG          PIC  X(3) VALUE "000".
	 02 WSS-CTRL-MENSAJERIA               PIC  X(4) VALUE "0000".
	 02 WSS-CTRL-M1-HOJA-VALIDA           PIC  X(1) VALUE "S". 
	 02 WSS-CTRL-M2-FIN-GRUPO             PIC  X(1) VALUE "S".
	 02 WSS-CTRL-M3-CAMBIO-CR             PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M4-NUM-HOJAS-1           PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M5-NUM-HOJAS-2           PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M6-NUM-HOJAS-4           PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M7-NUM-HOJAS-8           PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M8-SELECTIVA1            PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M9-SELECTIVA2            PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M10-SELECTIVA3           PIC  X(1) VALUE "N".
	 02 WSS-CTRL-M11-GENERAL              PIC  X(1) VALUE "N".
	 02 WSS-CTRL-IND-ENVIAR-RETENER       PIC  X(1) VALUE " ".
   02 WSS-CTRL-FILLER39                 PIC  X(39) VALUE SPACES.
   
 01 WSS-CTRL-CF-REG.                                                                                 
   02 WSS-CTRL-CF-PRODUCTO              PIC  X(5) VALUE SPACES.
   02 WSS-CTRL-CF-FILLER2               PIC  X(2) VALUE SPACES.            
   02 WSS-CTRL-CF-TRAMA                 PIC  X(3) VALUE "CF3".
   02 WSS-CTRL-CF-FILLER1               PIC  X(1) VALUE SPACES.


 PROCEDURE DIVISION.
 DECLARATIVES.

 DECL-FILE-SALIDA SECTION.
    USE AFTER ERROR PROCEDURE ON FILE-SALIDA.
    DISPLAY WSS-PROG-ID "Error en Archivo de SALIDA !!! Importante !!!, Error Cobol : "
    WS-FILE-STATUS, " Error Guardian : " GUARDIAN-ERR UPON HOME-TERM.
    ENTER TAL ABEND.
 END DECLARATIVES.

 Main.
    PERFORM Inicio
    if ENOERR perform Proceso.
    PERFORM Fin
 STOP RUN.

 Inicio.
     INITIALIZE entidad-reg sareacb-reg satrxcto-reg scodpost-reg sctofide-reg
                sedopais-reg semisora-reg sempnego-reg sjournal-reg sr2fistt-reg
                srefisac-reg srefiscm-reg srefisdf-reg srefisdo-reg srefisdt-reg
                srefismc-reg srefispc-reg srefispe-reg srefisre-reg srefistt-reg
                srfcatal-reg srfdiscl-rec srffolmc-reg srefisfc-reg spais-reg
                H-Liquidaciones w-define-info valida-rfc-in hNumPersonaAnt
                hNumContratoAnt wss-file-num h-negocio h-fecha-hoy h-hora-hoy
                h-wss-folio
     perform 8000-call-tgetmyid
     move " <<CFREFFIS >> Inicia Ejecucion ( Genera tramas )"
       to ess-msg-oper-l3-txt-error
     move "               D I V I D E N D O S "
       to ess-msg-oper-l4-txt-error
     perform 8000000-mensajes-operador
     perform 8005-maneja-parametros.
     move eneg-cve-empresa to wss-archivo
     move jour-campo-ad2   to wss-numero-exp
     move wss-numero-exp   to wss-archivo (5:)
     if fide-num-contrato = 0
        move "NO" to wss-archivo (7:)
     else
        move "FI" to wss-archivo (7:).

 Proceso.
      move 1.42857142 to rffc-factor-piramidacion
      exec sql open CUR_DIVS end-exec
      if SQLCODE = 0
         PERFORM with test after until SQLCODE = 100 or EERR
            exec sql fetch CUR_DIVS
               INTO :hNumContrato, :hNumPersona, :hCveTpoPersona, :hCveRolCto,
                    :hCveRFC, :hNombrePersona, :hNacionalidad, :hNumInstrumento,
                    :hDescInstrumento, :hMesIniVigencia, :hMesFinVigencia,
                    :hTpoProceso, :hPorcDistribucion, :hDividendoBrutoSujetoRet,
                    :hISRretenidoExtranjero, :hTotalDividendo, :hRetencion10ISRadivExt
            end-exec

            if SQLCODE = 0 or 8417 or 8403
               perform mueve-datos-libreria
               call CFREFRFC using valida-rfc-in
               move linkd-codx-rfc to hCveRFC
               if hNumPersona NOT = hNumPersonaAnt
                  perform 9010-select-srefisdo
                  MOVE 1 TO xFlagDemo
                  if hNumPersonaAnt NOT = ZERO                      
                      perform registra-sjournal
                  end-if
              end-if
              if xFlagDemo = 1 
                 PERFORM 1000-TRAMAS-CFDI
                 MOVE 0 TO xFlagDemo
              end-if
              
               

               move hNumPersona  to hNumPersonaAnt
               move hNumContrato to hNumContratoAnt
            else
               if SQLCODE not = 100
                  set ESQLERR to TRUE
                  DISPLAY "*** ERROR " SQLCODE " DESPUES FETCH"
                  upon HOME-TERM
               end-if
            end-if
         END-PERFORM
         EXEC SQL CLOSE CUR_DIVS END-EXEC
      else
         set ESQLERR to TRUE
         DISPLAY "*** ERROR " SQLCODE " AL ABRIR CURSOR"
         upon HOME-TERM
      end-if.

 mueve-datos-libreria.
     MOVE hNumContrato   TO linkd-num-contrato
     MOVE hNumPersona    TO linkd-num-persona
     MOVE hCveTpoPersona TO linkd-cve-tipo-persona
     MOVE hCveRFC        TO linkd-codx-rfc
     MOVE hNacionalidad  TO linkd-nacionalidad
     MOVE "N"            TO linkd-rfc-sat
     MOVE "N"            TO linkd-lib-resp.

 Fin.
     move " <<CFREFFIS >> Termina Ejecucion ( Dividendos )"
       to ess-msg-oper-l3-txt-error
     perform 8000000-mensajes-operador.

 8005-maneja-parametros.
      set ENOERR to TRUE
      initialize jour-campo-ad2 eneg-cve-empresa fide-num-contrato
      move "EMPRESA" to p-parametro
      perform 8010-parametro-alfanum
      move p-valor-alfanum to eneg-cve-empresa
      if eneg-cve-empresa not = "CBOL" and "BANC"
         set INVALIDPARAM to TRUE
         move "Los valores para el parametro 'empresa' deben ser 'CBOL'"
            to ess-msg-oper-l3-txt-error
         move "o 'BANC'"
            to ess-msg-oper-l3-txt-error (57:)
         perform 8000000-mensajes-operador.
      if ENOERR
         move "TPODIV" to p-parametro
         perform 8010-parametro-alfanum
         move 99 to jour-campo-ad2
         evaluate p-valor-alfanum
             when "NOQFIN"     move 1 to jour-campo-ad2
             when "QFIN"       move 2 to jour-campo-ad2
             when "PIRAMIDADO" move 3 to jour-campo-ad2
             when "ISRNAC"     move 4 to jour-campo-ad2
             when "ISREXT"     move 5 to jour-campo-ad2
*--          when "RESUMEN"    move 6 to jour-campo-ad2
             when  other move 99 to jour-campo-ad2
         end-evaluate
         if jour-campo-ad2 = 99
            set INVALIDPARAM to TRUE
            move "Los valores para el parametro 'tpodiv' deben ser 'NOQFIN'"
               to ess-msg-oper-l3-txt-error
            move ",'QFIN',"
              to ess-msg-oper-l3-txt-error (57:)
            move "'PIRAMIDADO','ISRNAC','ISREXT' o 'RESUMEN'"
               to ess-msg-oper-l4-txt-error
            perform 8000000-mensajes-operador.
      if ENOERR
         move "FIDE" to p-parametro
         perform 8010-parametro-alfanum
         move 99 to fide-num-contrato
         evaluate FUNCTION UPPER-CASE(p-valor-alfanum)
             when "N" move 0 to fide-num-contrato
             when "S" move 1 to fide-num-contrato
             when  other move 99 to fide-num-contrato
         end-evaluate
         if fide-num-contrato = 99
            set INVALIDPARAM to TRUE
            move "Los valores para el parametro 'fide' deben ser 'N' o 'S'"
               to ess-msg-oper-l3-txt-error
            perform 8000000-mensajes-operador.

 8000-CALL-TGETMYID.
      ENTER TAL "TGETMYID" USING WSS-PARA-TGMID-PROGFILE
      WSS-PARA-TGMID-PROCNAME WSS-PARA-TGMID-USERGROUP.

 8010-PARAMETRO-ALFANUM.
      INITIALIZE P-VALOR-ALFANUM P-VALOR-NUM P-RESULTADO
      MOVE FUNCTION UPPER-CASE(P-PARAMETRO) TO P-PARAMETRO
      ENTER GETPARAMTEXT
          USING P-PARAMETRO P-VALOR-ALFANUM
         GIVING P-RESULTADO
      MOVE FUNCTION UPPER-CASE (P-VALOR-ALFANUM)
        TO P-VALOR-ALFANUM.

 8013-PARAMETRO-NUM.
      INITIALIZE P-VALOR-ALFANUM P-VALOR-NUM P-RESULTADO
      ENTER GETPARAMTEXT
          USING P-PARAMETRO  P-VALOR-NUM
         GIVING P-RESULTADO.

 9010-select-srefisdo.
    initialize hInfoDomicilio
    exec sql
         select rfdo_num_estado
               ,TRIM(UPPER(rfdo_codx_postal))
               ,TRIM(UPPER(rfdo_cve_pais))
               ,TRIM(UPPER(rfdo_txt_delegacion_municipio))
               ,TRIM(UPPER(rfdo_txt_calle_num))
               ,TRIM(UPPER(rfdo_txt_colonia))
               ,CASE WHEN copo_centro_reparto is NULL
                     THEN 0 ELSE copo_centro_reparto END
               ,TRIM(UPPER(CASE WHEN edop_desc_estado is NULL
                     THEN "" ELSE edop_desc_estado END))
          INTO :hNumEstado
              ,:hCodxPostal
              ,:hCvePais
              ,:hTxtDelegacionMunicipio
              ,:hTxtCalleNum
              ,:hTxtColonia
              ,:hNumCentroReparto
              ,:hDescEstado
          from =srefisdo
     left join =scodpost on rfdo_codx_postal=copo_codigo_postal
     left join =sedopais on rfdo_num_estado=edop_num_estado
          where rfdo_anio_mes=2015*100+:hMesFinVigencia
            and rfdo_num_contrato=:hNumContrato
            and rfdo_num_persona=:hNumPersona
            and rfdo_codx_tipo_domicilio="POST"
         browse access
    end-exec
    if SQLCODE = 100
       initialize hInfoDomicilio
    else
       if SQLCODE Not = 0 and NOT = 8423
          set ESQLERR to TRUE
          display "*** Err " SQLCODE " On SELECT-SREFISDO" upon HOME-TERM
          enter tal "SQLCADISPLAY" using SQLCA
          enter tal "ABEND".
    initialize SQLCODE.

  0010-Escribe-reg.
      if wss-file-num = 0
         perform 0010-borra-archivo
         perform 0310-abre-archivo
      end-if
      move function LENGTH(regsalida) to wss-record
      enter "writex"
      using wss-file-num regsalida wss-record omitted omitted
      enter "file_getinfo_"
              using wss-file-num wss-salida-error-code
      if wss-salida-error-code not = zeroes
         set EBADFILE to TRUE
         display "*** Err " wss-salida-error-code " On WRITEX "
                  wss-nombre-archivo upon HOME-TERM
         enter tal "ABEND"
      end-if.

 0010-borra-archivo.
      enter tal "FILE_PURGE_"
          using wss-nombre-archivo
         giving wss-error-tal
      if wss-error-tal NOT = ZERO and not = 11
         display wss-prog-id "error code " wss-error-tal
                             " on 'file_purge'"
                             upon HOME-TERM STOP RUN
      else
         enter tal "PROCESSFILESECURITY" using 2340
         enter tal "FILE_CREATE_"
             using wss-nombre-archivo wss-file-len 0 wss-primary
                   wss-secondary wss-maxextents wss-filetype 0 wss-record
            giving wss-error-tal
         if wss-error-tal = 0
            display "Se genera el archivo = " WSS-NOMBRE-ARCHIVO upon HOME-TERM
         else
            display wss-prog-id "*** Err " wss-error-tal
                                " on 'FILE_CREATE_'"
                                upon HOME-TERM STOP RUN
         end-if
      end-if.

 0310-abre-archivo.
      enter "FILE_OPEN_"
         using wss-nombre-archivo wss-file-num wss-access
               wss-exclusion
        giving wss-salida-error-code
      if wss-salida-error-code not = 0
         display wss-prog-id "*** Err " wss-error-tal
                             " on 'FILE_OPEN_' "
                             wss-nombre-archivo
                             upon HOME-TERM STOP RUN
      end-if.

 registra-sjournal.
     ENTER TAL BEGINTRANSACTION
     perform GetFolioSjournal
     ACCEPT h-fecha-hoy from DATE YYYYMMDD
     ACCEPT h-hora-hoy  from TIME
     move hNumContratoAnt    to jour-num-contrato
     move hNumPersonaAnt     to jour-num-persona
     move "SIN9412025I4"     to jour-rfc-entidad
     if eneg-cve-empresa = "CBOL"
         move "SIC920427R31" to jour-rfc-entidad
     end-if
     move "PENDIENTE"        to jour-status
     move h-fecha-hoy        to jour-fecha-registro
     move h-hora-hoy         to jour-hora-registro
     move 2015               to jour-anio
     move FUNCTION UPPER-CASE(hCveRolCto)
                             to jour-tipo-persona
     EXEC SQL
          INSERT INTO =SJOURNAL
          VALUES (:jour-num-id ,:jour-num-folio-acep ,:jour-num-folio-canc
                 ,:jour-num-contrato ,:jour-num-persona ,:jour-rfc-entidad
                 ,:jour-fecha-registro ,:jour-hora-registro ,:jour-status
                 ,:jour-fecha-aceptacion ,:jour-hora-aceptacion
                 ,:jour-fecha-cancelacion ,:jour-hora-cancelacion ,:jour-anio
                 ,:jour-tipo-persona ,:jour-campo-ad ,:jour-campo-ad1
                 ,:jour-campo-ad2 ,:jour-campo-ad3)
          For Repeatable access
     END-EXEC.
     if SQLCODE = 0 or 100
        ENTER TAL ENDTRANSACTION
     else
        set ESQLERR to TRUE
        display "*** Err " SQLCODE " On INSERT-SJOURNAL" upon HOME-TERM
        enter tal "SQLCADISPLAY" using SQLCA
        enter tal "ABEND"
     end-if.

 GetFolioSjournal.
     EXEC SQL
          SELECT CASE WHEN MAX(JOUR_NUM_ID) IS NULL THEN 0
                      ELSE MAX(JOUR_NUM_ID) END + 1
           INTO :JOUR-NUM-ID
           FROM =SJOURNAL
        BROWSE ACCESS
     END-EXEC.
     IF SQLCODE NOT = 0
        set ESQLERR to TRUE
        display "*** Err " SQLCODE " On SELECT-SJOURNAL" upon HOME-TERM
        enter tal "SQLCADISPLAY" using SQLCA
        enter tal "ABEND"
     END-IF.

 ABRE-SQL-UPDATE-JOURNAL.
*===================
*  Por si no te vuelvo a ver:
*  Transicion de estados del UUID: PENDIENTE/CONFIRMADO/PEND.CANC/CANCELADO.
*  Nueva historia directo al estado CONFIRMADO, si el registro es
*  PEND.CANC/CANCELADO, o PENDIENTE/CONFIRMADO con diferente UUID.
*  En caso de reproceso, solo se actualiza fecha y hora.
*  Un UUID podria ser reactivado * a saber *
    EXEC SQL
         UPDATE =SJOURNAL
             SET jour_fecha_registro = :jour-fecha-registro
                ,jour_hora_registro  = :jour-hora-registro
                ,jour_status         = :jour-status
           WHERE jour_num_contrato   = :jour-num-contrato
             AND jour_num_persona    = :jour-num-persona
             AND jour_campo_ad2      = :jour-campo-ad2
    END-EXEC.
    EVALUATE SQLCODE
        WHEN 0  ENTER TAL ENDTRANSACTION
        WHEN 100
*           ENTER TAL ABORTTRANSACTION
            PERFORM REGISTRA-SJOURNAL
            ENTER TAL ENDTRANSACTION
*           DISPLAY "   SJOURNAL.No existe Cto: " RFPE-NUM-CONTRATO
*                   " Persona: "  RFPE-NUM-PERSONA
*                   " tpoCFDI: "  JOUR-CAMPO-AD2
*                   UPON HOME-TERM
    END-EVALUATE.

 COPY MENSAJES-OPERADOR OF "$DESA12.SCOGLCPA.C85DEFPG".
*-----------------------------------------------------------------------------
 1000-TRAMAS-CFDI.
    if xFlagDemo = 1
       PERFORM 1001-GENERALES
       PERFORM 1100-AC-AG1
       PERFORM 1200-AC-AG2
       PERFORM 1300-AC-AG3
       PERFORM 1400-AC-AG4
       PERFORM 1500-AC-AG5
       PERFORM 1600-AC-AG6
       PERFORM 1700-AC-AG7
       PERFORM 1800-AC-LEX
       PERFORM 1900-AC-CO8
       PERFORM 2000-AC-LY
       
       PERFORM 1002-INI-AC
               
    end-if
    
    PERFORM 4000-AC-RNG
    PERFORM 4100-AC-RNE
    
    
    
    
    
*    PERFORM 4000-AC-CF-LY1.
*    PERFORM 4100-AC-CF-LY2.
*    PERFORM 4200-AC-CF-LY3.
*    PERFORM 4300-AC-CF-LY4.
*    PERFORM 4400-AC-CF-LY5.
*    PERFORM 4500-AC-CF-LY61.
*    PERFORM 4600-AC-CF-LY62.
*    PERFORM 4700-AC-CF-LY71.
*    PERFORM 4800-AC-CF-LY72.
*    PERFORM 4900-AC-CF-LY8.
*    PERFORM 4000-AC-CF-LY91.
*    PERFORM 4100-AC-CF-LY92.
    
 1002-INI-AC.
  MOVE 0 TO xAc-TEX-TotDivBruto
  MOVE 0 TO xAc-TEX-TotIsrRetExt
  MOVE 0 TO xAc-TEX-TotDividendo
  MOVE 0 TO xAc-TEX-TotIsrAdicional
                                                                                                    
  MOVE 0 TO  xAc-RNE-TotDivNal 
  MOVE 0 TO  xAc-RNE-TotDivPiramidado 
  MOVE 0 TO  xAc-RNE-TotIsrAcreditable 
                                                  
  MOVE 0 TO  xAc-RNG-TotDivNal 
  MOVE 0 TO  xAc-RNG-TotDivPiramidado
  MOVE 0 TO  xAc-RNG-TotIsrAcreditable
  MOVE 0 TO  xAc-RNG-TotIsrAdicional
  
  MOVE 0 TO C-CFA
  MOVE 0 TO C-CFB
  MOVE 0 TO C-CFBP
  MOVE 0 TO C-CFC.
  
*INI ARRAY       
         
      
 1001-GENERALES.
    MOVE "R" TO   xSelectProceso
    MOVE "00" TO  xTipoReExpedicion
    move "01" to xDia
    move "01" to xMes
    move "10" to xHora
    move "10" to xMin
         
    MOVE jour-campo-ad2        TO xTipoDividendo
    if xTipoDividendo = 1 
       MOVE "Pago definitivo"  TO xTipoRetencion.
    if xTipoDividendo = 2 
       MOVE "Pago definitivo"  TO xTipoRetencion.
    if xTipoDividendo = 3
       MOVE "Pago provisional" TO xTipoRetencion.
    if xTipoDividendo = 4
       MOVE "Pago definitivo"  TO xTipoRetencion.
    if xTipoDividendo = 5
       MOVE "Pago definitivo"  TO xTipoRetencion.
       
    MOVE  "MONTERREY, NUEVO LEÓN" TO xAG5LugarExpedicion 
    STRING  "LIBRAMIENTO NORTE A SANTA ROSA NO. 111, "  DELIMITED BY SIZE
           ,"COL. FUTURO APODACA. MONTERREY, NUEVO LEÓN." DELIMITED BY SIZE INTO xLEXLugarExp 
           
    IF eneg-cve-negocio="CBOL"
       MOVE "CBDIC" TO WSS-CTRL-PRODUCTO
       MOVE "CBDIC" TO WSS-CTRL-CF-PRODUCTO
       
       STRING "SCOTIA INVERLAT CASA DE BOLSA S.A. DE C.V., " DELIMITED BY SIZE
              "GRUPO FINANCIERO SCOTIABANK INVERLAT"         DELIMITED BY SIZE 
              INTO xAG5NombreEmisor
              
       MOVE "SIC920427R31" TO xAG5RFCemisor
       STRING "BOSQUES DE CIRUELOS 120 PISO 4, "         DELIMITED BY SIZE
              "BOSQUES DE LAS LOMAS, Miguel Hidalgo, "  DELIMITED BY SIZE
              "Distrito Federal  11700"                 DELIMITED BY SIZE
              INTO xAG6DirEMISOR.
    
    IF eneg-cve-negocio = "BANC"
      MOVE "CBDIB" TO WSS-CTRL-PRODUCTO
      MOVE "SCOTIABANK INVERLAT, S.A." TO xAG5NombreEmisor                                                                                                                                                                                                                    
      MOVE "SIN9412025I4" TO xAG5RFCemisor                                                                                                     
      STRING "CALLE LORENZO BOTURINI 202, " DELIMITED BY SIZE
             "COLONIA TRÁNSITO,"            DELIMITED BY SIZE
             "CÓDIGO POSTAL 06820"          DELIMITED BY SIZE
             "MÉXICO D.F., "                DELIMITED BY SIZE
             "DELEGACIÓN CUAUHTÉMOC"        DELIMITED BY SIZE
             INTO xAG6DirEMISOR.             
    
 1002-AC-CONTROL.
     ADD 1 TO WSS-CR
     MOVE WSS-CR TO WSS-CTRL-CONSECUTIVO-REG.                                               
 1100-AC-AG1.           
      PERFORM 1002-AC-CONTROL
      STRING "AG1"              DELIMITED BY SIZE INTO  WSS-CTRL-TRAMA                           
      STRING hNombrePersona     DELIMITED BY SIZE INTO  WSS-AG1-NOMBRE        
      STRING WSS-CTRL-PRODUCTO  DELIMITED BY SIZE INTO  WSS-AG1-CLAVE-PRODUCTO
      STRING hNumContrato       DELIMITED BY SIZE INTO  WSS-AG1-CONTRATO      
      STRING hCveRFC            DELIMITED BY SIZE INTO  WSS-AG1-RFC                
      STRING eneg-cve-negocio   DELIMITED BY SIZE INTO  WSS-AG1-EMPRESA       
      STRING hNacionalidad      DELIMITED BY SIZE INTO  WSS-AG1-NACIONALIDAD        
      
      MOVE " " TO REGSALIDA
      STRING  WSS-CTRL-REG      DELIMITED BY SIZE
             ,WSS-AG1-REG       DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 1200-AC-AG2.
      PERFORM 1002-AC-CONTROL
      STRING "AG1"                                   DELIMITED BY SIZE INTO WSS-CTRL-TRAMA
      STRING "DIVIDENDOS O UTILIDADES DISTRIBUIDAS"  DELIMITED BY SIZE INTO  WSS-AG2-TITULO-PRODUCTO  
      STRING hMesIniVigencia                         DELIMITED BY SIZE INTO  WSS-AG2-PERIODO-INICIAL  
      STRING hMesFinVigencia                         DELIMITED BY SIZE INTO  WSS-AG2-PERIODO-FINAL    
      STRING "2015"                                  DELIMITED BY SIZE INTO  WSS-AG2-EJERCICIO        
      STRING "000000"                                DELIMITED BY SIZE INTO  WSS-AG2-PROPORCION                       
      STRING "2016-" , xMes , "-" , xDia             DELIMITED BY SIZE INTO  WSS-AG2-FECHA-EXPEDICION       
      STRING xHora , "-" ,xMin , "-00"               DELIMITED BY SIZE INTO  WSS-AG2-HORA-EXPEDICION                       
      STRING "0" , xTipoDividendo                    DELIMITED BY SIZE INTO  WSS-AG2-TIPO-DIVIDENDO

      MOVE " " TO REGSALIDA 
      STRING  WSS-CTRL-REG DELIMITED BY SIZE
             ,WSS-AG2-REG  DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.             
 1300-AC-AG3.
      PERFORM 1002-AC-CONTROL
      STRING  "AG3"                  DELIMITED BY SIZE INTO WSS-CTRL-TRAMA
      STRING hTxtCalleNum            DELIMITED BY SIZE INTO WSS-AG3-CALLE-NUMERO    
		  STRING hTxtColonia             DELIMITED BY SIZE INTO WSS-AG3-COLONIA         
	  	STRING hTxtDelegacionMunicipio DELIMITED BY SIZE INTO WSS-AG3-CIUDAD          
	  	STRING hCodxPostal             DELIMITED BY SIZE INTO WSS-AG3-CODIGO-POSTAL   
		  STRING hNumCentroReparto       DELIMITED BY SIZE INTO WSS-AG3-CODIGO-CR       
		  STRING "2015-12-31"            DELIMITED BY SIZE INTO WSS-AG3-FECHA-CORTE
		  
		  MOVE " " TO REGSALIDA
      STRING  WSS-CTRL-REG           DELIMITED BY SIZE
             ,WSS-AG3-REG            DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 1400-AC-AG4.
      PERFORM 1002-AC-CONTROL
      STRING "AG4"                      DELIMITED BY SIZE INTO WSS-CTRL-TRAMA
      STRING "2016-", xMes , "-" ,xDia  DELIMITED BY SIZE INTO WSS-AG4-FECHA-EXPEDICION   
		  STRING xHora  , "-"  ,xMin ,"-00"  DELIMITED BY SIZE INTO WSS-AG4-HORA-EXPEDICION  
		       
		  MOVE " " TO REGSALIDA
      STRING  WSS-CTRL-REG             DELIMITED BY SIZE
             ,WSS-AG4-REG              DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 1500-AC-AG5.
      PERFORM 1002-AC-CONTROL
      MOVE "AG5"                     TO WSS-CTRL-TRAMA
      MOVE xAG5RFCemisor             TO WSS-AG5-RFC-EMISOR		  
		  MOVE xAG5NombreEmisor          TO WSS-AG5-NOMBRE-EMISOR
		  MOVE xAG5LugarExpedicion       TO WSS-AG5-LUGAR-EXPEDICION
		  STRING "2016-" ,xMes ,"-",xDia DELIMITED BY SIZE INTO WSS-AG5-FECHA-EXPEDICION
      
      MOVE " " TO REGSALIDA
      STRING  WSS-CTRL-REG DELIMITED BY SIZE
              WSS-AG5-REG DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
 1600-AC-AG6.
      PERFORM 1002-AC-CONTROL
      MOVE "AG6" TO WSS-CTRL-TRAMA
      STRING xAG6DirEMISOR DELIMITED BY SIZE INTO  WSS-AG6-DIR-EMISOR
      
      MOVE " " TO REGSALIDA
      STRING   WSS-CTRL-REG DELIMITED BY SIZE
              ,WSS-AG6-REG DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
 1700-AC-AG7.
      PERFORM 1002-AC-CONTROL
      MOVE "AG7" TO WSS-CTRL-TRAMA
  	  MOVE "1.0" TO WSS-AG7-VER-CFDI
		  MOVE "1.0" TO WSS-AG7-VER-COMP
		  MOVE xTipoRetencion TO WSS-AG7-TIPO-PAGO-RET
		  MOVE "14" TO WSS-AG7-CVE-RET

      MOVE " " TO REGSALIDA
      STRING  WSS-CTRL-REG DELIMITED BY SIZE
              ,WSS-AG7-REG DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 1800-AC-LEX.
      PERFORM 1002-AC-CONTROL
      MOVE "LEX" TO WSS-CTRL-TRAMA
      STRING xLEXLugarExp DELIMITED BY SIZE INTO WSS-LEX-LUGAR-EXP
      
      MOVE " " TO REGSALIDA
      STRING  WSS-CTRL-REG DELIMITED BY SIZE
              ,WSS-LEX-REG DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 1900-AC-CO8.
      PERFORM 1002-AC-CONTROL
      MOVE "CO8" TO WSS-CTRL-TRAMA
      if xSelectProceso = "R"
         MOVE "01"  TO WSS-NODE-EXP.
      
      MOVE " " TO REGSALIDA
      STRING  WSS-CTRL-REG DELIMITED BY SIZE
              ,WSS-CO8-REG DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 2000-AC-LY.    
      PERFORM 2001-AC-LY-TEXT.
      PERFORM 2100-AC-LY1.  
      PERFORM 2200-AC-LY2.  
      PERFORM 2300-AC-LY3.  
      PERFORM 2400-AC-LY4.  
      PERFORM 2500-AC-LY5.  
      PERFORM 2600-AC-LY61. 
      PERFORM 2700-AC-LY62. 
      PERFORM 2800-AC-LY71. 
      PERFORM 2900-AC-LY72. 
      PERFORM 3000-AC-LY8.  
      PERFORM 3100-AC-LY9.  

 2001-AC-LY-TEXT. 
      STRING "La presente constancia se expide en cumplimiento "  DELIMITED BY SIZE
             ,"a lo previsto en la legislación fiscal."           DELIMITED BY SIZE  INTO WSS-LY1   
      
      STRING "(1) El 10% de Impuesto sobre la Renta adicional por " DELIMITED BY SIZE
             ,"Dividendos es un impuesto definitivo "               DELIMITED BY SIZE
             ,"y por lo tanto no acreditable."                      DELIMITED BY SIZE INTO WSS-LY2
             
             
      STRING "(2) Provienen de la CUFIN 2014 en adelante."         DELIMITED BY SIZE INTO WSS-LY3 
    
      STRING "(3) Conforme a lo establecido en la Regla 3.1.5 " DELIMITED BY SIZE
            ,"de la Resolución Miscelánea Fiscal ,legislación " DELIMITED BY SIZE
            ,"fiscal aplicable al ejercicio 2015."              DELIMITED BY SIZE INTO  WSS-LY4
    
      STRING "Verificar el tratamiento con su asesor "          DELIMITED BY SIZE
            ,"fiscal particular."                               DELIMITED BY SIZE INTO WSS-LY5 
            
      STRING "Lo anterior se encuentra de conformidad a lo dispuesto "  DELIMITED BY SIZE 
            ,"en los artículos 142 y 164 de la Ley del Impuesto sobre " DELIMITED BY SIZE
            ,"la Renta y las Reglas de Resolución Mis"                  DELIMITED BY SIZE INTO WSS-LY61
            
      STRING "celánea Fiscal aplicables al ejercicio fiscal 2015."      DELIMITED BY SIZE INTO WSS-LY62
      
      STRING "Esta constancia contiene el resumen de los "  DELIMITED BY SIZE
            ,"resultados obtenidos durante el periodo que " DELIMITED BY SIZE
            ,"ampara la misma,asimismo adjunto a esta se "  DELIMITED BY SIZE
            ,"muestra a nivel detalle dichos resultados."   DELIMITED BY SIZE INTO WSS-LY71
     
      STRING "alle dichos resultados."                      DELIMITED BY SIZE INTO WSS-LY72
   	 
   	  STRING "CIFRAS EXPRESADAS EN PESOS"                   DELIMITED BY SIZE INTO WSS-LY8
      
      STRING "La presente constancia sustituye para todos los "    DELIMITED BY SIZE    
            ,"efectos legales a que haya lugar, a cualquier otro " DELIMITED BY SIZE
            ,"documento emitido con anterioridad por SCOTIA INVER" DELIMITED BY SIZE INTO WSS-LY91-CB-00
             
      STRING "LAT CASA DE BOLSA S.A. DE C.V., GRUPO FINANCIERO " DELIMITED BY SIZE
            ,"SCOTIABANK INVERLAT, para los mismos efectos del " DELIMITED BY SIZE
            ,"presente contrato "                                DELIMITED BY SIZE INTO WSS-LY92-1-CB-00                  
       
      STRING " por el período que ampar" DELIMITED BY SIZE INTO WSS-LY92-3-CB-00
       
      STRING "a la misma."  DELIMITED BY SIZE INTO WSS-LY93-CB-00
                                                                                                                                                                                                              
      STRING "Se emite la presente constancia a petición del interesado, "   DELIMITED BY SIZE
             ,"la cual sustituye para todos los efectos legales a que haya " DELIMITED BY SIZE
             ,"lugar, a cualquier otro documen"                              DELIMITED BY SIZE INTO WSS-LY91-CB-01
             
      STRING "to emitido con anterioridad para los mismos efectos "     DELIMITED BY SIZE
             ,"por SCOTIA INVERLAT CASA DE BOLSA S.A. DE C.V., "        DELIMITED BY SIZE
             ,"GRUPO FINANCIERO SCOTIABANK INVERLAT, del contrato "     DELIMITED BY SIZE INTO WSS-LY92-1-CB-01
      
      STRING " por el período que ampara la misma."                     DELIMITED BY SIZE INTO WSS-LY92-3-CB-01
                                                                                                                                                                                                              
      STRING "La presente constancia sustituye para todos los efectos " DELIMITED BY SIZE
             ,"legales a que haya lugar, a cualquier otro documento "   DELIMITED BY SIZE
             ,"emitido con anterioridad por SCOTIABANK I"	              DELIMITED BY SIZE INTO WSS-LY91-BN-00
      
      STRING "NVERLAT, S.A., para los mismos efectos del presente contrato " DELIMITED BY SIZE INTO WSS-LY92-1-BN-00
      
      STRING " por el período que ampara la misma."                        DELIMITED BY SIZE INTO WSS-LY92-3-BN-00                       
                                                                                                                                                                                                             
      STRING "Se emite la presente constancia a petición del interesado, " DELIMITED BY SIZE
             ,"la cual sustituye para todos los efectos legales a "        DELIMITED BY SIZE
             ,"que haya lugar, a cualquier otro documen"                   DELIMITED BY SIZE INTO  WSS-LY91-BN-01
      
      STRING "to emitido con anterioridad para los mismos efectos "        DELIMITED BY SIZE
            ,"por  SCOTIABANK INVERLAT,S.A., del contrato "                DELIMITED BY SIZE INTO WSS-LY92-1-BN-01
      
      STRING " por el período que ampara la misma."                        DELIMITED BY SIZE INTO  WSS-LY92-3-BN-01
      DISPLAY "lY".
                        
 2100-AC-LY1.
      PERFORM 1002-AC-CONTROL
      MOVE "LY1" TO WSS-CTRL-TRAMA      
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY1      DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 2200-AC-LY2.
      if xTipoDividendo = 1 Or xTipoDividendo = 4 Or xTipoDividendo = 6 
        PERFORM 1002-AC-CONTROL
        MOVE "LY2" TO WSS-CTRL-TRAMA       
      
        STRING WSS-CTRL-REG DELIMITED BY SIZE
              ,WSS-LY2 DELIMITED BY SIZE INTO REGSALIDA
        perform 0010-Escribe-reg
      end-if.
      
 2300-AC-LY3.
     If xTipoDividendo = 1 Or xTipoDividendo = 6 
        PERFORM 1002-AC-CONTROL
        MOVE "LY3" TO WSS-CTRL-TRAMA 
        STRING WSS-CTRL-REG DELIMITED BY SIZE
              ,WSS-LY3 DELIMITED BY SIZE INTO REGSALIDA
        perform 0010-Escribe-reg
     end-if.
      
 2400-AC-LY4.
      PERFORM 1002-AC-CONTROL
      MOVE "LY4" TO WSS-CTRL-TRAMA
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY4 DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 2500-AC-LY5.
      PERFORM 1002-AC-CONTROL
      MOVE "LY5" TO WSS-CTRL-TRAMA     
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY5 DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.   
      
 2600-AC-LY61.
      PERFORM 1002-AC-CONTROL
      MOVE "LY6" TO WSS-CTRL-TRAMA
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY61 DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.  
      
 2700-AC-LY62.
      PERFORM 1002-AC-CONTROL
      MOVE "LY6" TO WSS-CTRL-TRAMA      
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY62      DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 2800-AC-LY71.
      PERFORM 1002-AC-CONTROL
      MOVE "LY7" TO WSS-CTRL-TRAMA
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY71     DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 2900-AC-LY72.
      PERFORM 1002-AC-CONTROL
      MOVE "LY7" TO WSS-CTRL-TRAMA
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY72     DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 3000-AC-LY8.
      PERFORM 1002-AC-CONTROL
      MOVE "LY8" TO WSS-CTRL-TRAMA
      STRING WSS-CTRL-REG DELIMITED BY SIZE
            ,WSS-LY8      DELIMITED BY SIZE INTO REGSALIDA
      perform 0010-Escribe-reg.
      
 3100-AC-LY9.
      If xSelectProceso = "R" and  xTipoReExpedicion = "00"              
         If WSS-CTRL-PRODUCTO = "BANC"      
            STRING  WSS-LY91-BN-00 DELIMITED BY SIZE
                    INTO WSS-LY91
                        
            STRING  WSS-LY92-1-BN-00 DELIMITED BY SIZE
                       ,WSS-AG1-CONTRATO      DELIMITED BY SIZE
                       ,WSS-LY92-3-BN-00  DELIMITED BY SIZE INTO WSS-LY92                       
        end-if
        
        if WSS-CTRL-PRODUCTO = "CBOL" 
            STRING  WSS-LY91-CB-00 DELIMITED BY SIZE
                    INTO WSS-LY91
                        
            STRING  WSS-LY92-1-CB-00      DELIMITED BY SIZE
                       ,WSS-AG1-CONTRATO      DELIMITED BY SIZE
                       ,WSS-LY92-3-CB-00  DELIMITED BY SIZE INTO WSS-LY92
                
            STRING  WSS-LY93-CB-00 DELIMITED BY SIZE
                    INTO WSS-LY93
        end-if            
      end-if
          
      if xSelectProceso = "R"  and xTipoReExpedicion = "01"
         if WSS-CTRL-PRODUCTO = "BANC"      
            STRING  WSS-LY91-BN-01 DELIMITED BY SIZE
                    INTO WSS-LY91
                        
            STRING  WSS-LY92-1-BN-01      DELIMITED BY SIZE
                       ,WSS-AG1-CONTRATO  DELIMITED BY SIZE
                       ,WSS-LY92-3-BN-01  DELIMITED BY SIZE INTO WSS-LY92
         end-if
         if WSS-CTRL-PRODUCTO = "CBOL" 
            STRING  WSS-LY91-CB-01 DELIMITED BY SIZE
                    INTO WSS-LY91
                        
            STRING  WSS-LY92-1-CB-01      DELIMITED BY SIZE
                       ,WSS-AG1-CONTRATO  DELIMITED BY SIZE
                       ,WSS-LY92-3-CB-01  DELIMITED BY SIZE INTO WSS-LY92
                
            STRING  WSS-LY93-CB-01 DELIMITED BY SIZE
                    INTO WSS-LY93     
         end-if    
      end-if   
      if xSelectProceso = "R"         
         PERFORM 1002-AC-CONTROL
         MOVE "LY9" TO  WSS-CTRL-TRAMA
         STRING WSS-CTRL-REG DELIMITED BY SIZE
               ,WSS-LY91     DELIMITED BY SIZE INTO REGSALIDA
         perform 0010-Escribe-reg
        
         PERFORM 1002-AC-CONTROL
         MOVE "LY9" TO  WSS-CTRL-TRAMA
         STRING WSS-CTRL-REG DELIMITED BY SIZE
               ,WSS-LY92     DELIMITED BY SIZE INTO REGSALIDA
         perform 0010-Escribe-reg
          
         if WSS-CTRL-PRODUCTO = "CBOL" 
	          PERFORM 1002-AC-CONTROL
	          MOVE "LY9" TO  WSS-CTRL-TRAMA
	          STRING WSS-CTRL-REG DELIMITED BY SIZE
	                ,WSS-LY93     DELIMITED BY SIZE INTO REGSALIDA
            perform 0010-Escribe-reg
        end-if    
     end-if.
     
     
     
 4000-AC-RNG.
     if xTipoDividendo = 1 
        MOVE hDescInstrumento             TO RNG-Emisora        
        MULTIPLY hTotalDividendo          BY hPorcDistribucion GIVING RNG-DivNal
        MULTIPLY hRetencion10ISRadivExt   BY hPorcDistribucion GIVING RNG-IsrAdicional
        
        COMPUTE xAc-TNG-TotDivNal         = xAc_TNG_TotDivNal         + RNG-DivNal   
        COMPUTE xAc-TNG-TotIsrAdicional   = xAc-TNG-TotIsrAdicional   + RNG-IsrAdicional   
        ADD 1 TO C-CFA
	      STRING WSS-CTRL-PRODUCTO
	            ,"  "
	            ,"CFA "
	            ,RNG-Emisora
	            ,"|"
	            ,RNG-DivNal
	            ,"|"
	            ,"|"
	            ,RNG-IsrAdicional INTO WSS-T-CFA(C-CFA)
	      
        PERFORM 1002-AC-CONTROL
	      MOVE "RNG" TO  WSS-CTRL-TRAMA
	   
	      STRING WSS-CTRL-REG DELIMITED BY SIZE
	            ,WSS-RNG-REG  DELIMITED BY SIZE INTO WSS-T-RNG(C-CFA)

     end-if.
     
 4010-AC-TNG.    
    If xTipoDividendo = 1
       PERFORM 1002-AC-CONTROL
	     MOVE "TNG" TO  WSS-CTRL-TRAMA	     
	     STRING WSS-CTRL-REG DELIMITED BY SIZE
	           ,WSS-TNG-REG  DELIMITED BY SIZE INTO REGSALIDA
        PERFORM 0010-Escribe-reg             	   
	  End-If   
    
 4020-AC-CT1
      If xTipoDividendo = 1                
        MOVE "CT1" TO  WSS-CTRL-CF-TRAMA
        STRING WSS-CTRL-CF-TRAMA              
              ,"|TOTAL|" 
              ,xAc-TNG-TotDivNal
              ,"|"
              ,"|"
              ,"|"
              , xAc-TNG-TotIsrAdicional  DELIMITED BY SIZE INTO REGSALIDA
              
      End-If.

        
 4100-AC-RNE_2.            
     if xTipoDividendo = 2
        MOVE hDescInstrumento             TO RNE-2-Emisora
        MULTIPLY hTotalDividendo          BY hPorcDistribucion GIVING RNE-2-DivNal
        
	      COMPUTE xAc-RNE-TotDivNal         = xAc_RNE_TotDivNal + RNE-2-DivNal   
	      
	      ADD 1 TO C-CFB
	      PERFORM 1002-AC-CONTROL
	      MOVE "RNE" TO  WSS-CTRL-TRAMA    	      
	      STRING WSS-CTRL-REG DELIMITED BY SIZE
	            ,WSS-RNE-2-REG  DELIMITED BY SIZE INTO WSS-T-RNE-2(C-CFB)
        
	      
	      STRING  WSS-CTRL-PRODUCTO
	            ,"  "
	             "CFB "
	            ,RNE-Emisora
	            ,"|"
	            ,RNE-DivNal
	            ,"|"
	            ,RNE-DivPiramidado
	            ,"|"
	            ,RNE-IsrAcreditable INTO WSS-T-CFB-PIRAMIDADO(C-CFB)
	      
	      
     end-if.
4100-AC-RNE_3.            
     if xTipoDividendo = 3
        MOVE hDescInstrumento             TO RNE-Emisora
        MULTIPLY hTotalDividendo          BY hPorcDistribucion GIVING RNE-3-DivNal
        MULTIPLY hDividendoBrutoSujetoRet BY hPorcDistribucion GIVING RNE-3-DivPiramidado        
	      MULTIPLY hISRretenidoExtranjero   BY hPorcDistribucion GIVING RNE-3-IsrAcreditable
	      
	      COMPUTE xAc-RNE-3-TotDivNal         = xAc_RNE_3-TotDivNal + RNE-3-DivNal   
	      COMPUTE xAc-RNE-3-TotDivPiramidado  = xAc-RNE-3-TotDivPiramidado  + RNE-3-DivPiramidado 
	      COMPUTE xAc-RNE-3-TotIsrAcreditable = xAc-RNE-3-TotIsrAcreditable + RNE-3-isrCorporativo 
	      
	      ADD 1 TO C-CFBP
	      PERFORM 1002-AC-CONTROL
	      MOVE "RNE" TO  WSS-CTRL-TRAMA    	      
	      STRING WSS-CTRL-REG DELIMITED BY SIZE
	            ,WSS-RNE-REG  DELIMITED BY SIZE INTO WSS-T-RNE(C-CFBP)
        
	      
	      STRING  WSS-CTRL-PRODUCTO
	            ,"  "
	             "CFB "
	            ,RNE-Emisora
	            ,"|"
	            ,RNE-DivNal
	            ,"|"
	            ,RNE-DivPiramidado
	            ,"|"
	            ,RNE-IsrAcreditable INTO WSS-T-CFB-PIRAMIDADO(C-CFB)
	      
	      
     end-if.     


4100-AC-CT2.
        
    MOVE "CT2" TO  WSS-CTRL-CF-TRAMA
    If xTipoDividendo = 3
       STRING WSS-CTRL-CF-TRAMA              
            ,"|TOTAL|" 
            ,xAc-RNE-3-TotDivNal   
            ,"|"
            ,xAc-RNE-3-TotDivPiramidado 
            ,"|"
            ,xAc-RNE-3-TotIsrAcreditable DELIMITED BY SIZE INTO REGSALIDA
    end-if    
        
        
        
        
    If xTipoDividendo = 2
    
        
        STRING WSS-CTRL-CF-TRAMA              
              ,"|TOTAL|" 
              ,xAc-TNE-TotDivNal
              ,"|"
              ,"|"
              DELIMITED BY SIZE INTO REGSALIDA
              
      End-If.
                         

     
     
          
 4200-AC-RE1.
  If xTipoDividendo = 1 or   xTipoDividendo = 2  or xTipoDividendo = 4
     PERFORM 1002-AC-CONTROL
     MOVE "RE1" TO  WSS-CTRL-TRAMA    	      
     If xTipoDividendo = 1 
       	RE11-DIVIDENDO-NACIONAL-GRAVADO = xAc-TNG-TotDivNal
     		RE11-ISR-NACIONAL               = xAc-TNG-TotIsrAdicional         			      
	      STRING WSS-CTRL-REG  DELIMITED BY SIZE
	            ,WSS-RE1-1-REG DELIMITED BY SIZE INTO REGSALIDA    		
     end-if
      
     if xTipoDividendo = 2
        RE12-DIVIDENDO-NACIONAL-EXENTO = xAc-RNE-TotDivNal
        STRING WSS-CTRL-REG  DELIMITED BY SIZE
	            ,WSS-RE1-2-REG DELIMITED BY SIZE INTO REGSALIDA     		
     end-if
     
     if xTipoDividendo = 4
        RE14-DIVIDENDO-EXTRANJERA = xAc-TEX-TotDivBruto    
        RE14-ISR-EXTRANJERA       = xAc-TEX-TotIsrAdicional          
        STRING WSS-CTRL-REG  DELIMITED BY SIZE
	            ,WSS-RE1-4-REG DELIMITED BY SIZE INTO REGSALIDA     		
     end-if
     PERFORM 0010-Escribe-reg
  end-if.
  
 4300-AC-RE2.
  If xTipoDividendo = 3 or xTipoDividendo = 5
     PERFORM 1002-AC-CONTROL
     MOVE "RE2" TO  WSS-CTRL-TRAMA    	      
     If xTipoDividendo = 3 
       	RE23-DIV-ACUMULABLE   = xAc_TEX-TotDivBruto
     		RE23-RET-EXT          = xAc_TEX-TotIsrRetExt         			      
	      STRING WSS-CTRL-REG  DELIMITED BY SIZE
	            ,WSS-RE2-3-REG DELIMITED BY SIZE INTO REGSALIDA     		
     end-if
      
     if xTipoDividendo = 5
        RE25-DIV-PIRAMIDADO  = xAc-RNE-TotDivPiramidado  + xAc-RNG-TotDivPiramidado
        RE25-ISR-ACREDITABLE = xAc-RNE-TotIsrAcreditable + xAc-RNG-TotIsrAcreditable
        STRING WSS-CTRL-REG  DELIMITED BY SIZE
	            ,WSS-RE2-5-REG DELIMITED BY SIZE INTO REGSALIDA     		
     end-if
     
     PERFORM 0010-Escribe-reg
  end-if.   
     